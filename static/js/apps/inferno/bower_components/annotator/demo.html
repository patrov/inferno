<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>JS annotation test</title>
        <link type="text/css" rel="stylesheet" href="/static/js/kimonic/vendor/bootstrap/dist/css/bootstrap.min.css"/>
        <!-- jQuery must be included before Annotator -->
        <script src="lib/vendor/jquery.js"></script>

        <!-- If you're sure your users will only be using browsers modern
             enough to have their own JSON.parse and JSON.stringify
             implementations you can skip this -->
        <script src="lib/vendor/json2.js"></script>

        <!-- The main Annotator script -->
        <script src="pkg/annotator.min.js"></script>

        <!-- Annotator's styling and images -->
        <link rel="stylesheet" type="text/css" href="pkg/annotator.min.css">

        <!-- The following plugins are entirely optional -->

        <!-- The Store plugin. Saves annotations to a remote backend -->
        <script src="pkg/annotator.store.min.js"></script>

        <!-- The Auth plugin. Allows users of Annotator to authenticate themselves
             to the remote backend -->
        <script src="pkg/annotator.auth.min.js"></script>

        <!-- The Permissions plugin. See who created which annotation and create
             annotations as a specified user -->
        <script src="pkg/annotator.permissions.min.js"></script>

        <!-- The Tags plugin. Edit and display tag keywords on annotations -->
        <script src="pkg/annotator.tags.min.js"></script>

        <!-- The Markdown plugin. Treat annotation text as Markdown -->
        <script src="lib/vendor/showdown.js"></script>
        <script src="pkg/annotator.markdown.min.js"></script>
        <style>
            .annotator-item {font-size: x-small; vertical-align: super}
            .annotator-hl {background: orange}
            .badge {color: white}
			.badge.annotation-no {font-size: 10px; padding: 1px 4px; vertical-align: super}
            .badge.badge-hl {opacity: 0.5; line-height: none; display: inline; line-height: none; font-size:inherit; padding:0 2px; border-radius: 0 !important; filter:alpha(opacity=50); background: orange }
			.annotation-no > .annotator-hl {background: none; font-weight: smaller;}

        </style>
    </head>

    <body>

        <div class="container">

            <h1>Javascript annotation service test</h1>

            <div class='col-sm-7'>

                <div id="airlock">
                    <p><strong>Pellentesque habitant morbi tristique</strong> senectus<span class='note-test'>1</span> et netus suada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. <em>Aenean ultricies mi vitae est.</em> Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, <code>commodo vitae</code>, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. <a href="#">Donec non enim</a> in turpis pulvinar facilisis. Ut felis.</p>

                    <h2>Header Level 2</h2>

                    <ol>
                        <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>
                        <li>Aliquam tincidunt mauris eu risus.</li>
                    </ol>

                    <blockquote><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus magna. Cras in mi at felis aliquet congue. Ut a est eget ligula molestie gravida. Curabitur massa. Donec eleifend, libero at sagittis mollis, tellus est malesuada tellus, at luctus turpis elit sit amet quam. Vivamus pretium ornare est.</p></blockquote>

                    <h3>Header Level 3</h3>

                    <ul>
                        <li id="listone">Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>
                        <li id="listtwo">Aliquam tincidunt mauris eu risus.</li>
                    </ul>

                    <pre>
                        <code>
                            #header h1 a {
                              display: block;
                              width: 300px;
                              height: 80px;
                            }
                        </code>
                    </pre>
                </div>
            </div>

            <div class='col-sm-5'>
                <h4><strong>Annotation</strong></h4>
                <div class='media-ctn'>
                    <div class="media" style='display:none'>
                        <div class="media-left">
                            <a href="#"> <img alt="64x64" data-src="holder.js/64x64" class="media-object" style="width: 64px; height: 64px;" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTMxN2QxZmUzNCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MzE3ZDFmZTM0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxMi41IiB5PSIzNi44Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true">
                            </a>
                        </div>
                        <div class="media-body"> <h4 class="media-heading">Media heading</h4><div class='annotation-content'></div> </div> <div class="media-right"> <a href="#"> <img alt="64x64" data-src="holder.js/64x64" class="media-object" style="width: 64px; height: 64px;" src="data:imsage/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTMxN2QyMTAyNCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MzE3ZDIxMDI0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxMi41IiB5PSIzNi44Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true"> </a> </div>
                    </div>
                </div>
            </div>

        </div>


        <script>

            /*
             * 1/ we can't annotate between node 
             * 
             * 
             */

            jQuery(function ($) {

                Annotator.Plugin.TerzaEditor = function (element, option) {}

                /* terza editor */
                jQuery.extend(Annotator.Plugin.TerzaEditor.prototype, new Annotator.Plugin(), {


                    pluginInit: function () {
                        this.store = [];
                        this.itemRenderer = jQuery('.media').clone().show();
                        this.annotationViewerPanel = jQuery('.media-ctn').eq(0);
                        this.onDeleteNote = function () {}

                        this.bindEvents();
                    },

                    getAnnotationById: function (key) {
                        var item = null, self = this;
                        jQuery.each(this.store, function (i) {
                            if (self.store[i].id === key) {
                                item = self.store;
                                return true;
                            }
                            return item;
                        });
                    },

                    bindEvents: function () {
                        var self = this;

                        this.annotator.subscribe('annotationEditorShown', function (editor) {
                            /* change editor here */
                            console.log(editor);
                        });

                        this.annotator.subscribe('annotationCreated', this.handleNewAnnotation.bind(this));

                        this.annotationViewerPanel.on("click", '.annotation-content', this.handle);
                    },
                    
                    updateView: function () {
                        var store = this.annotator.plugins.Store.annotations, self = this, 
                            annotationViewPanel = this.annotationViewerPanel, 
                            annotationItem = this.itemRenderer, item;
                        
                        
                    annotationViewPanel.empty();
                        jQuery.each(store, function (no) {
                            item = store[no];
                            annotationItem = jQuery(annotationItem).clone();
                            jQuery(annotationItem).find('.annotation-content').html(item.text);
                            annotationViewPanel.append(annotationItem);

                            jQuery(annotationItem).data('annotation-item', item);
                            annotationItem.on('mouseenter', self.handleAnnotationMouseOver.bind(self));
                            annotationItem.on('mouseleave', self.handleMouseLeave.bind(self));
                        });
                    },
                    
                    
                    
                    buildBadge: function (badgeInfos) {
                        var badgeNo = jQuery(badgeInfos).data('badge-no'),
                            badge = jQuery('<i/>').addClass(" badge annotation-no").html(badgeNo);   
                           badge.data("annotation", jQuery(badgeInfos).data('annotation'));
                        if(!badgeNo) {return false; }
                        jQuery(badgeInfos).replaceWith(badge);
                    },
                    
                    handleMouseLeave: function (e) {
                        var annotation = jQuery(e.currentTarget).data("annotation-item"), 
                            badgeInfos = jQuery('.badge-infos'),
                            self = this;
                    
                        if (!annotation) { return false; }
                        if(!annotation.highlights.length) { return false; }
                        
                        jQuery(annotation.highlights).map(function () {
                            jQuery(this).contents().unwrap();
                        });
                        
                        /* show badges */
                        jQuery('.badge-hl').removeClass('badge-hl');                      
                    },
                    
                    showAnnotationsOptions: function () {
                        /* Ajouter fonction éditer et effacer ici ! */
                    },
                    
                    handleAnnotationMouseOver: function (e) {
                        var annotation = jQuery(e.currentTarget).data('annotation-item'),
                            annotationBefore = 0; 
                        if (!annotation) { return false; }
                        /* hide button and show them */                        
                        jQuery(annotation.highlights).map(function () {
                            jQuery(this).css({border: '1px solid blue'});
                        });
                        
                        /* normalize before setup */
                        t = this.annotator.setupAnnotation(annotation);                        
                        jQuery(t.highlights).map(function () {
                            var parent = jQuery(this).parent();
                            if (parent.hasClass('annotation-no')) {
                                var badgeInfos = jQuery('<i/>').addClass('badge-infos');
                            badgeInfos.data("annotation", jQuery(parent).data("annotation"));    
                            badgeInfos.data("badge-no", jQuery(parent).data("annotation").position);
                            //jQuery(parent).replaceWith(badgeInfos);
							parent.addClass("badge-hl");
                            }
                        });                        
                    },

                    getNumber: (function() {
                      var cpt = 0;
                      return function () {
                          cpt = cpt + 1;
                          return cpt;
                      };
                    }()),

                    showSelection: function (annotation) {
                        this.annotator.highlightRange(annotation.ranges, 'rdacial_sd');
                    },
                    
                    updateAnnotationPosition: function () {
                        /* find all badge */
                        var badges = jQuery('.annotation-no');
                        badges.map(function (i) {
                            jQuery(this).html(i + 1);
                            annotation = jQuery(this).data('annotation');
                            annotation.position = i + 1;
                        });
                        
                    },
                    
                    handleNewAnnotation: function (annotation) {
                    /* When a new annotation is created
                     * associate a provis number then update all the numbers.
                     * */
                        var noBadge = jQuery('<span>-</span>').clone(),
                             nb,
                            nbHl = annotation.highlights.length; 
                            noBadge.addClass('badge');
                            
                       jQuery.each(annotation.highlights, function (i) {
                           
                        nb = i + 1 ;
                        if (nb === nbHl) { //last item
                            jQuery(noBadge).addClass('annotation-no');
                            jQuery(annotation.highlights[i]).append(noBadge);
                            jQuery(annotation.highlights[i]).contents().unwrap();
                            jQuery(noBadge).data('annotation', annotation);
                        } else {
                            jQuery(annotation.highlights[i]).contents().unwrap();
                        }
                     });
                    
                    annotation.highlights = [];
                    this.updateAnnotationPosition();
                    this.updateView();
                    }
                });


                if (typeof $.fn.annotator !== 'function') {
                    alert("Ooops! it looks like you haven't built the Annotator concatenation file. " +
                        "Either download a tagged release from GitHub, or modify the Cakefile to point " +
                        "at your copy of the YUI compressor and run `cake package`.");
                } else {
                    // This is the important bit: how to create the annotator and add
                    // plugins
                    $('#airlock').annotator({
                        readOnly: false
                    })
                    .annotator('addPlugin', 'Store')
                    .annotator('addPlugin', 'TerzaEditor')
                    .annotator('addPlugin', 'Markdown')
                    .annotator('addPlugin', 'Tags');

                    $('#airlock').data('annotator');
                }


            });
        </script>
    </body>


</html>
